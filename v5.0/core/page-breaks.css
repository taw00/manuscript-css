/* Page breaks and simulated page breaks
 *
 * Note, if you start mixing up odd things sometimes page breaking can get odd
 * as well. So, be mindful if you see a blank page or stacks of simulated page
 * break lines or parts and chapters with no scene afterward, that maybe you
 * shouldn't have done whatever you have done.
 *
 * Copyright (c) Todd Warner
 * This work is licensed under Attribution 4.0 International. To view a copy
 * of this license, visit http://creativecommons.org/licenses/by/4.0/
 */


/*
 * PAGE BREAKS, SIMULATED
 */
@media screen {
    #manuscript {
        /*
         * The simulated page break line and offset
         */

        /* We paint the faux page-break ABOVE the thing forcing a break
         * Books & Parts.
         * Chapters unless they come after a part.
         * Scenes if they come after books or the title page. */
        & section:is(.m-book,.m-part,.m-chapter):has( > .m-title ),
        /*&:is(.long,.poetry) > .m-title > section.m-scene:first-of-type,*/
        & section:is(.m-book) > section.m-scene:first-of-type {
            padding-block-start: var(--m-offset-title);
            border-block-start: var(--m-page-break-simulated);
        }

        /* poetry and any sections after poetry */
        & .m-title + .m-poem,
        & section + .m-poem,
        & section.m-poem + section {
            border-block-start: var(--m-page-break-simulated-long);
        }

        /* The title page makes everything strange.
         * We paint a break line below the m-count for long manuscripts and
         * poetry. But then we have to account for all the stuff that wants to
         * paint a line above their elements. */
        &:is(.long,.poetry) > div.m-count {
            border-block-end: var(--m-page-break-simulated-long);
        }
        &:is(.long,.poetry):has( > div.m-count ) > section:first-of-type {
            /* Line is already painted at the END of .m-count */
            padding-block-start: unset;
            border-block-start: unset;
        }

        /* Remove the simulated line in additional cases
         * Parts > Chapters = no break above the Chapter
         * Parts > Scenes = no break above the Scene
         * Chapter > Scenes = no break above the Scene
         */
        /*
        & section:is(.m-scene,.m-book,.m-part,.m-chapter) + .m-scene,
        & section section:is(.m-scene,.m-book,.m-part,.m-chapter) + .m-scene,
        & section section section:is(.m-scene,.m-book,.m-part,.m-chapter) + .m-scene,
        & section section section section:is(.m-scene,.m-book,.m-part,.m-chapter) + .m-scene {
        */
        & section.m-part:has( > .m-title ) > section.m-chapter:first-of-type:has( > .m-title),
        & section.m-part:has( > .m-title ) > section.m-scene:first-of-type {
            padding-block-start: unset;
            border-block-start: unset;
        }


        /*
         * The simulated page break spacing
         */

        /* BOOK, PART, and CHAPTER title blocks start a distance down the page
         * using an offset from the top of the page-break simulation */
        & section.m-book:has( > .m-title),
        & section.m-part:has( > .m-title),
        & :not(.m-part) + .m-chapter:has( > .m-title, > section.m-scene) {
            /* Here we used padding in order to show the simulated page break
             * realistically. In the "print" section, use use margin-
             * instead. */
             /*
            padding-block-start: var(--m-offset-title);
            */
        }

        /* TITLE PAGE and BOOK and POEM - aesthetic end spacing -----------
         * Add aesthetic spacing at the end of an element that always has a
         * simulated page break coming after, and make the spacing similar to
         * the spacing before.  For poems, we just at a little to give the page
         * break after a poem a bit of elbow room.  We do it with a transparent
         * border so that we don't override and padding and margin styles */
        & > .m-title:has( ~ section),
        & section.m-book:has( > section) > .m-title {
            border-block-end: var(--m-page-break-simulated-end-spacing);
        }
        &:not(.long,.poetry):has( > section) > .m-title {
            border-block-end: 0;
        }
        & section.m-poem {
            border-block-end: var(--m-page-break-simulated-end-spacing-poem);
        }
    } /* end #manuscript */
} /* end @media screen */


/*
 * PAGE BREAKS
 */
@media print {
    #manuscript {
        /*
         * page-breaks dependent on 'short' vs. 'long'
         * :is(.long,.poetry) > .m-title + anything = page break
         * .m-book = page break
         * .m-book + anything = page break
         * .m-part = page break
         * .m-part > .m-chapter = NO page break (therefore not declared)
         * .m-chapter + .m-chapter = page break
         * .m-scene + .m-chapter = page break (why would this happen?)
         */
        &:is(.long,.poetry) > .m-title + section,
        & section.m-book:has( > .m-title),
        & section.m-book:has( > .m-title) + section,
        & section.m-part:has( > .m-title),
        & section.m-chapter:has( ~ section ) + .m-chapter:has( > .m-title ),
        & section.m-scene + .m-chapter:has( > .m-title ) {
            padding-block-start: var(--m-offset-title);
            break-before: var(--m-page-break);
        }

        /*
         * page-breaks that ALWAYS happen
         * .m-poem = page break
         * .m-poem + anything = page break
         */
        & section.m-poem,
        & section.m-poem + section {
            break-before: page;
        }

        /* BOOK, PART, and CHAPTER title blocks start a distance down the page
         * using an offset from the top of the page
         */
        & section.m-book:has( > .m-title),
        & section.m-part:has( > .m-title),
        & > .m-title ~ .m-chapter:has( > .m-title),
        & > .m-title ~ .m-chapter:has( > .m-scene),
        & section:not(.m-part) ~ .m-chapter:has( > .m-title),
        & section:not(.m-part) ~ .m-chapter:has( > section.m-scene) {
            /* Here we use margin to offset the titles in case margins need to
             * collapse (I am not 100% sure that we could not just use padding.
             * In the "screen" section we use padding in order to show the
             * simulated page break realistically. */
            /*
            margin-block-start: var(--m-offset-title);
            padding-block-start: 1px;
            */
            /*padding-block-start: var(--m-offset-title);*/
        }


        /*
         * Explicitly undoing things because CSS can be messy
         */
        /* being explicit because sometimes ~ used above can be too casual */
        /*
        & section:is(.m-scene,.m-book,.m-part,.m-chapter) ~ .m-scene,
        & section section:is(.m-scene,.m-book,.m-part,.m-chapter) ~ .m-scene,
        & section section section:is(.m-scene,.m-book,.m-part,.m-chapter) ~ .m-scene,
        & section section section section:is(.m-scene,.m-book,.m-part,.m-chapter) ~ .m-scene {
            break-before: revert;
        }
        */


        /* AVOIDANCE ----- */

        & a,
        & tr {
            break-inside: avoid-page !important;
        }

        & :is(h1, h2, h3, h4, h5, h6),
        & :is(img, figure) {
            break-inside: avoid-page !important;
            break-after: avoid-page !important;
        }


        /* avoid page break inside a note */
        & .m-note,
        /* avoid page break inside a poem stanza */
        & .x-poem pre,
        & section.m-poem pre,
        /* avoid page break inside a header block */
        & .m-facts,
        & .m-contact,
        & .m-count {
            break-inside: avoid-page !important;
        }

        /* avoid page break before a dinkus or -30- marker */
        & section.m-scene::after,
        &::after,
        & h6 {
            break-before: avoid-page !important;
            break-inside: avoid-page !important;
        }
    } /* end #manuscript */

    #vpage, #manuscript {
        break-before: avoid-page !important;
    }

} /* end @media print */

