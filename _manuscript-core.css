/* Manuscript via CSS v2.0 — the core styles
 *
 * This contains all of the baseline logic for formatting—via CSS styles—a
 * a markdown or HTML document to present a rendered artifact that closely
 * follows industry-standard prose manuscript guidelines.
 *
 * Though this stylesheet alone is sufficient to enable formatting manuscripts
 * for US letter-dimensioned short-prose narratives, it's really intended to
 * act as support for manuscript.css. Import that stylesheet instead.
 *
 * Copyright (c) Todd Warner <t0dd@protonmail.com>
 * This work is licensed under Attribution 4.0 International. To view a copy
 * of this license, visit http://creativecommons.org/licenses/by/4.0/
 */

@import "_manuscript-style-reset.css";
@import "_manuscript-config.css";

html { font-size: var(--m-font-size); } /* 1rem defined */
html, body { background-color: rgb(204,204,204); } /* off-white */

#manuscript {
    color: black !important;
    background-color: rgba(0,0,0,0);
    font-family: var(--m-font-family);
    font-size: 1rem;
    font-weight: var(--m-font-weight);
    line-height: var(--m-line-spacing);
    /* -- future feature (still in a w3c draft)
    hyphenate-limit-chars: 6 3 2;
    hyphenate-limit-lines: 2;
    */
}
#manuscript * {
    opacity: 1;
    padding: 0;
}
#manuscript *:not(hr) {
    margin: 0; border: 0;
}
/* because hr is resistent to change apparently (a mystery for now) */
#manuscript hr { color: black !important;
                 border-color: black !important; }
#manuscript a, a:is(:any-link,:link,:active,:visited,:hover) {
    color: var(--m-link-color);
    text-decoration: none;
}
#manuscript a:hover { border-bottom: solid var(--m-link-color) 2px; }

/* rendering to the screen
 * HTML and BODY are off-white. We add a pretty 3D virtual white page with
 * #vpage and configure the content container to hold the text within.
 * Implemenation note: #vpage and #manuscript use a combination of position
 * box-sizing and overflow that cannot change or the layout gets weird (though
 * overflow could still be set to auto, theoretically. */
@media screen {
/* a virtual page */
#vpage {
    display: block;
    position: relative; box-sizing: border-box; overflow: hidden;
    top: 0; left: 0;
    width: 100%; max-width: var(--m-page-width);
    margin: 10px auto;
    background-color: white !important;
    box-shadow: 0 0 20px black;
}
/* the content container */
#manuscript {
    display: block;
    position: relative; box-sizing: border-box; overflow: hidden;
    width: 100%; max-width: var(--m-content-width);
    margin: var(--m-page-margin) auto;
    border: var(--m-manuscript-border);
}
} /* /screen */

/* printing / exporting to the actual page
 * HTML and BODY need to be transparent and the vpage container becomes
 * undefined (@page replaces its purpose) and the manuscript container goes back
 * to being a plain 'ol box filling the page.
 */
@media print {
html, body { background-color: rgba(0,0,0,0); }
} /* /print */

/* blockquote, pre, and code
 * These are often specifically styled by markdown editors to something other
 * than the browser default. So we have to be a bit more "forceful" when we
 * style them for our purposes. (See also manuscript-joplin-taming.css) */
#manuscript blockquote {
    border: 0;
    margin: var(--m-elbow-room) var(--m-margins-blockquote);
    /* so many markdown tools manipulate these. overriding */
    padding: 0; background-color: inherit;
}
#manuscript pre {
    white-space: pre;
    overflow-x: auto; /* allow scroll bars */
    font-size: var(--m-font-size-preformatted);
    font-weight: var(--m-font-weight-preformatted);
    font-family: var(--m-font-family-preformatted);
    margin: var(--m-elbow-room) var(--m-margins-preformatted);
    line-height: var(--m-line-spacing-preformatted);
    /* so many markdown tools manipulate these. overriding */
	color: inherit; background-color: inherit;
}
@media print { #manuscript pre { overflow-x: hidden; } } /* no scroll bars */
#manuscript pre > code {
    font-size: inherit; font-weight: inherit; font-family: inherit;
    white-space: inherit;
    line-height: inherit;
    /* so many markdown tools manipulate these. overriding */
	color: inherit; background-color: inherit;
}
#manuscript :not(pre) > code {
    font-size: var(--m-font-size-preformatted-inline);
    font-weight: var(--m-font-weight-preformatted-inline);
    font-family: var(--m-font-family-preformatted);
    white-space: inherit;
    /* so many markdown tools manipulate these. overriding */
	color: inherit; background-color: inherit;
}

#manuscript #m-contact {
    position: absolute; box-sizing: border-box; overflow: visible;
    /* 1px because the page sometimes cuts off a character just a smidge */
    top: 0px; left: 0px;
}
#manuscript #m-contact p {
    line-height: var(--m-line-spacing-top-heading);
    text-align: left;
}

#manuscript #m-facts {
    position: var(--m-position-facts);
    box-sizing: border-box; overflow: visible;
    top: var(--m-top-facts); bottom: var(--m-bottom-facts);
    left: var(--m-left-facts); right: var(--m-right-facts);
    margin: var(--m-margin-facts);
}
#manuscript #m-facts p {
    line-height: var(--m-line-spacing-facts);
    text-align: var(--m-text-align-facts);
}

/* per-component top margins
 * Formatting notes -- (these assertions need to be retested)
 * - '#manuscript div.m-header' must always exist in the document.
 *   This block contains the manuscript title and whatnot.
 * - Parts: if there are multiple parts, '#m-part div.m-header'
 *   must exist for each part.
 * - Chapters: if there are multiple chapters '#m-part div.m-header'
     must exist for each chapter. If this is a long-form manuscript,
     this formatting CSS expects chapters.
 * - Scenes: '#m-scene div.m-header' ... doesn't have to (and probably
     shouldn't) exist. */

/* place the manuscript title block 1/3rd or 5/12th down the page */
#manuscript > .m-header {
    margin: var(--m-offset-title) auto var(--m-room-for-two);
}

/* part and chapter top margins (may be large (long) or small (short))
 * But only if they have a title block, otherwise, it's assumed no margin */
#manuscript section:is(.m-part, .m-chapter) > .m-header {
    margin-top: var(--m-offset-parts-and-chapters-render) !important;
}
@media print {
/* part and chapter top margins (may be large (long) or small (short))
 * But only if they have a title block, otherwise, it's assumed no margin */
#manuscript section:is(.m-part, .m-chapter) > .m-header {
    margin-top: var(--m-offset-parts-and-chapters) !important;
}
}

/* scenes: small margin betwen scenes and whatever precedes */
#manuscript section.m-scene {
    margin-top: var(--m-offset-scene) !important;
}
/* the prose content:
 * small margin between prose content and a scene's title block if it exists */
#manuscript section.m-scene > .m-header + * {
    margin-top: var(--m-elbow-room) !important;
}

/* Inside of an .m-header:
 * - H1 means title, H2 means subtitle, H3 means author
 * - > (i.e. blockquote) means epigraph
 * - And finally, if you want you can wrap word count, audience, and genre
 *   in an #m-facts div.
 *
 * Inside of a .m-scene where all the prose goes, H1 through H5 means ...
 * header 1 through header 5 as you would expect. And the > (blockquote) also
 * works as you would expect there.
 *
 * H6, though, is always reserved as a dinkus or a -30- marker */
#manuscript section.m-scene::after, /* a dinkus separator */
#manuscript h6, /* a dinkus separator */
#manuscript .m-header > :is(h1, h2, h3, h4, h5, h6),
#manuscript .m-header p {
    display: block;
    line-height: var(--m-line-spacing);
    margin: 0; padding: 0; border: 0;
}
#manuscript section.m-scene::after,
#manuscript h6,
#manuscript .m-header > :is(h1, h2, h3, h4, h5, h6),
#manuscript .m-header > p,
#manuscript .m-header :is(:not(blockquote)) p {
    text-align: center !important;
}
manuscript .m-header p {
    font-size:   var(--m-font-size);
    font-weight: var(--m-font-weight);
}
#manuscript > .m-header > h1 {                           /* title: main work */
    font-size: var(--m-font-size-title);
    font-weight: var(--m-font-weight-title);
    font-family: var(--m-font-family-title);
}
#manuscript > .m-header > h2 {                        /* subtitle: main work */
    font-size: var(--m-font-size-subtitle);
    font-weight: var(--m-font-weight-subtitle);
    font-family: var(--m-font-family-subtitle);
}
#manuscript > .m-header > h3 {                          /* author: main work */
    font-size: var(--m-font-size-author);
    font-weight: var(--m-font-weight-author);
    font-family: var(--m-font-family-author);
}
#manuscript > section.m-part > .m-header > h1 {               /* title: part */
    font-size: var(--m-font-size-title-part);
    font-weight: var(--m-font-weight-title-part);
    font-family: var(--m-font-family-title-part);
}
#manuscript > section.m-part > .m-header > h2 {            /* subtitle: part */
    font-size: var(--m-font-size-subtitle-part);
    font-weight: var(--m-font-weight-subtitle-part);
    font-family: var(--m-font-family-subtitle-part);
}
#manuscript > section.m-part > .m-header > h3 {            /* subtitle: part */
    font-size: var(--m-font-size-author-part);
    font-weight: var(--m-font-weight-author-part);
    font-family: var(--m-font-family-author-part);
}
#manuscript section.m-chapter > .m-header > h1 {           /* title: chapter */
    font-size: var(--m-font-size-title-chapter);
    font-weight: var(--m-font-weight-title-chapter);
    font-family: var(--m-font-family-title-chapter);
}
#manuscript section.m-chapter > .m-header > h2 {        /* subtitle: chapter */
    font-size: var(--m-font-size-subtitle-chapter);
    font-weight: var(--m-font-weight-subtitle-chapter);
    font-family: var(--m-font-family-subtitle-chapter);
}
#manuscript section.m-chapter > .m-header > h3 {          /* author: chapter */
    font-size: var(--m-font-size-author-chapter);
    font-weight: var(--m-font-weight-author-chapter);
    font-family: var(--m-font-family-author-chapter);
}
#manuscript section.m-scene > .m-header > h1 {               /* title: scene */
    font-size: var(--m-font-size-title-scene);
    font-weight: var(--m-font-weight-title-scene);
    font-family: var(--m-font-family-title-scene);
}
#manuscript section.m-scene > .m-header > h2 {            /* subtitle: scene */
    font-size: var(--m-font-size-subtitle-scene);
    font-weight: var(--m-font-weight-subtitle-scene);
    font-family: var(--m-font-family-subtitle-scene);
}
#manuscript section.m-scene > .m-header > h3 {              /* author: scene */
    font-size: var(--m-font-size-author-scene);
    font-weight: var(--m-font-weight-author-scene);
    font-family: var(--m-font-family-author-scene);
}
#manuscript section.m-scene::after,
#manuscript h6 {                   /* manuscript separators: dinkus and -30- */
    font-size: var(--m-font-size-dinkus-30-);
    font-weight: var(--m-font-weight-dinkus-30-);
    font-family: var(--m-font-family-dinkus-30-);
    margin-top: var(--m-elbow-room);
}

#manuscript .m-header > :is(h4, h5),                     /* all header prose */
#manuscript .m-header p {           /* h4, h5 were unaccounted for elements) */
    font-size: var(--m-font-size);
    font-weight: var(--m-font-weight);
    font-family: var(--m-font-family);
    line-height: var(--m-line-spacing);
    word-break: normal; overflow-wrap: break-word;
}

#manuscript :is(.m-header,blockquote,section.m-scene) p { /* prose+epigraphs */
    font-size: var(--m-font-size);
    font-weight: var(--m-font-weight);
    font-family: var(--m-font-family);
    line-height: var(--m-line-spacing);
    word-break: normal; overflow-wrap: break-word;
}

#manuscript .m-header > blockquote {                        /* the epigraphs */
    font-size: var(--m-font-size-epigraph);
    font-weight: var(--m-font-weight-epigraph);
    font-family: var(--m-font-family-epigraph);
    width: max-content;
    max-width: calc(var(--m-content-width) - calc(var(--m-page-margin) * 2));
    margin: var(--m-elbow-room) auto 0;
    word-break: normal; overflow-wrap: break-word;
}

/* insert a dinkus between scenes */
#manuscript section.m-scene::after { content: var(--m-dinkus); }
#manuscript section.m-scene:last-of-type::after { content: ""; }


/*
 * The prose
 */

/* Align left/start all the prose */
#manuscript blockquote p,
#manuscript section.m-scene p {
    text-align: var(--m-text-align);
    hyphens: var(--m-hyphens);
}

/* paragraph indentation / spacing for all the prose
 * (which one is enabled is determined by .narrative or .non-narrative) */
#manuscript blockquote p,
#manuscript section.m-scene p {
    text-indent: var(--m-indent);
    margin-top: var(--m-paragraph-spacing);
}

/* ... but not after certain classes/elements */
#manuscript section > :is(h1,h2,h3,h4,h5,h6) ~ p:first-of-type,
#manuscript :is(blockquote, section.m-scene) > p:first-of-type {
    text-indent: var(--m-indent-first-paragraph) !important;
    margin-top: 0;
}


/* PAGE BREAK LOGIC */

@media print {

/* page break after a manuscript title block or part header */
#manuscript > .m-header,
#manuscript section.m-part > .m-header {
    break-after: var(--m-page-break);
}
/* page break after a part */
#manuscript section.m-part {
    break-after: var(--m-page-break);
}
/* ...except for the last part */
#manuscript section.m-part:last-of-type {
    break-after: avoid !important;
}
/* page break after a chapter */
#manuscript section.m-chapter {
    break-after: var(--m-page-break);
}
/* ...except for the last chapter */
#manuscript section.m-chapter:last-of-type {
    /*break-after: unset !important;*/
    break-after: avoid !important;
}

} /* end of print rules */

@media screen {

/* page break (simulated) after a title or part header */
#manuscript > .m-header,
#manuscript section.m-part > .m-header {
    border-bottom: var(--m-page-break-simulated);
}
/* page break after a part */
#manuscript section.m-part {
    border-bottom: var(--m-page-break-simulated);
}
/* ...except for the last part */
#manuscript section.m-part:last-of-type {
    border-bottom: var(--m-page-break-simulated);
}
/* page break (simulated) after a chapter */
#manuscript section.m-chapter {
    border-bottom: var(--m-page-break-simulated);
}
/* ...except for the last chapter */
#manuscript section.m-chapter:last-of-type {
    border-bottom: 0 !important;
}

} /* end of screen rules */

/* END PAGE BREAK LOGIC */




/***
 * PAGE BREAK AVOIDANCE RULES
 ***/

@media print {
    /* general page break behavior for print documents */
    a { break-inside: avoid !important; }

    blockquote { break-inside: avoid !important; }

    h1, h2, h3, h4, h5, h6 {
        break-inside: avoid !important;
        break-after: avoid !important;
    }

    img {
        break-inside: avoid !important;
        break-after: avoid !important;
    }

    table, pre { break-inside: avoid !important; }
    ul, ol, dl { break-before: avoid !important; }

/*
 * god knows why, but these avoidance rules are not working
 * ********************************************************
 */

/* don't page break inside a title-block header */
#manuscript :is(section.m-part,section.m-chapter,section.m-scene) > .m-header {
    page-break-inside: avoid !important;
    break-inside: avoid !important;
}
/* don't page break after a chapter header or scene header */
#manuscript :is(section.m-chapter,section.m-scene) > .m-header {
    page-break-after: avoid !important;
    break-after: avoid !important;
}
/* don't page break before scene */
#manuscript section.m-scene,
#manuscript section.m-scene > .m-header {
    page-break-before: avoid !important;
    break-before: avoid !important;
}
/* don't page break before a chapter header's or scene header's first child */
#manuscript :is(section.m-chapter, section.m-scene) > .m-header + * {
    page-break-before: avoid !important;
    break-before: avoid !important;
}
/* don't page break before a dinkus or -30- marker */
#manuscript section.m-scene::after,
#manuscript h6 {
    page-break-before: avoid !important;
    break-before: avoid !important;
}
} /* end @media print */
