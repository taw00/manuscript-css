/* base elements initialization and top-level positioning and spacing
 *
 * For the base elements stuff, this also includes some of the white-space and
 * overflow settings. I debate whether these should go in the fonts.css
 * stylesheet.
 *
 * For the top-level positioning and spacing, we define the rules governing
 * - title page titles, contacts, and counts
 * - the sections, titles, and beginning contact spacing
 *
 * Copyright (c) Todd Warner
 * This work is licensed under Attribution 4.0 International. To view a copy
 * of this license, visit http://creativecommons.org/licenses/by/4.0/
 */


#vpage {
    position: relative;
    top: 0;
    left: 0;
}


#manuscript {
    position: relative;
    overflow: hidden;
    top: 0;
    left: 0;

    text-align: var(--m-text-align);
    text-justify: var(--m-text-justify);

    & blockquote {
        border: 0; padding: 0;
        margin-block: var(--m-elbow-room);
        margin-inline: var(--m-margin-blockquote);
    }

    /* <hr> lines */
    & hr {
        border-top: 0;  border-bottom-width: 1px;
        border-left: 0; border-right: 0;
        width: 80%;
    }


    /*
     * H-TAG BASELINE RULES (h1 … h6)
     * - note, this gets refined later depending on where the tag lands
     */
    & :is(h1, h2, h3, h4, h5, h6) {
        margin: 0; padding: 0; border: 0;
        text-align: var(--m-text-align);
    }

    & :is(dd) {
        margin-inline-start: var(--m-indent);
    }


    /*
     * PARAGRAPH BASELINE RULES (p)
     * - note, this gets refined later depending on where the p lands
     */
    & p {
        padding: 0; border: 0;
        word-break: normal; overflow-wrap: break-word;
        /* a paragraph after a non-paragraph is not indented */
        text-indent: var(--m-indent-first-paragraph);
        text-align: var(--m-text-align);
        margin-block: 0;
    }
    & ul > li > p,
    & ol > li > p,
    & dt > dd > p,
    & dt > dd {
        text-indent: 0;
    }
    & p ~ p,
    & dd ~ dd {
        /* a paragraph after a paragraph is either indented (narrative)
         * or not indented (nonnarrative) */
        text-indent: var(--m-indent);
        margin-block: var(--m-paragraph-spacing) 0;
    }


    /*
     * PREFORMATTED RULES (pre and code)
     */
    & pre {
        margin-block: var(--m-paragraph-spacing);
        word-break: normal; overflow-wrap: break-word;
        white-space: pre-wrap; /* wrap */
    }
    & pre > code {
        white-space: pre; /* no wrap */
        overflow-x: auto; /* allow scroll bars (turned off for PDF/print in page.css) */
    }
    & :is(ol,ul,dl,menu, li,dt,dd, table,thead,tbody,tfoot,th,tr,td,colgroup,col) pre ~ pre {
        margin-block-start: 0;
    }
    & .title pre {
        margin-block: var(--m-nudge);
    }

    /* ERROR ALERTING!
     * title pages, parts, chapters, and poems MUST have a title
     * scene CANNOT have a title
     * If not, we start painting things red.
     */
    & div.title-page:not(:has( > .title )),
    & section.part:not(:has( > .title )),
    & section.chapter:not(:has( > .title )),
    & section.poem:not(:has( > .title )),
    & section.scene > .title,
    & div.xxxxxxxx {
        color: red;
        &::before {
            display: block;
            position: abosolute;
            top: calc(var(--m-room-for-eight) + var(--m-room-for-two));
            z-index: 99;
            margin-inline: auto;
            padding: 5px 10px !important;
            color: black;
            background: yellow;
            border: 5px red solid;
            line-height: 1.25;
        }
    }
    & div.title-page:not(:has( > div.title ))::before {
        content: "ERROR: div.title-page is missing a div.title block";
    }
    & section.part:not(:has( > div.title ))::before {
        content: "ERROR: section.part is missing a div.title block";
    }
    & section.chapter:not(:has( > div.title ))::before {
        content: "ERROR: section.chapter is missing a div.title block";
    }
    & section.poem:not(:has( > div.title ))::before {
        content: 'ERROR: section.poem is missing a div.title block; '
                 'required even if the poem is untitled; in that case '
                 ' just add an empty <div class="title"></div>';
    }
    & section.scene > div.title::before {
        content: "ERROR: Scenes can't have titles. Remove the scene title block "
                 "and wrap the scene in an entitled chapter section instead. Or "
                 "manually insert #-style header indicators within the scene itself.";
    }


    /*
     * TITLE PAGES - layout and orientation
     * (1st page title page and interior title pages "books")
     *
     * Title page itself is initialized in init/structure.css
     * Title page structure is 'display: grid' and 2x2
     *
     * Note: interior title pages are discovered via
     * :is(div.title-page,section) + div.title-page
     *
     * 1st page title page and "long" documents interior title pages
     * - page breaks above and below
     * - .contact - 1st row, 1st col, upper left-hand corner
     * - .count - 1st row, 2nd col,  upper right-hand corder (SHORT)
     *              or 2nd row, spanned, centered, bottom (LONG)
     * - .title - 1st row, spanned 2 cols, centered, top-margin-offset
     *
     * Interior pages title pages:
     * - For "long" documents, see above.
     * - For "short" documents, the interior title pages .contact, .count,
     *   .title will all occupy the samelevel with some seperation from the
     *   previous block of text.
     *
     * We use the grid model for the title pages. The flex model settings have
     * mostly been saved as commented out blocks of code in init/structure.css,
     * core/top-level.css, and core/poem.css
     */

    /* title page width and height */
    & div.title-page {
        width: 100%; max-width: 100%;
    }
    & > div.title-page {
        height: auto;
    }
    &:is(.long,.poetry) > div.title-page {
        height: var(--m-content-height);
    }
    &:is(.long,.poetry) > :is(div.title-page,section) + div.title-page {
        height: var(--m-content-height-interior);
    }

    & > div.title-page > div.contact,
    & > div.title-page > div.count,
    & > div.title-page > div.title,
    & div.xxxxxxxx {
        grid-row: 1;
    }
    & > div.title-page > div.contact {
        grid-column: 1;
    }
    & > div.title-page > div.count {
        grid-column: 2;
    }
    & > div.title-page > div.title {
        grid-column: 1 / -1;
        display: flex;
        justify-content: center;
        flex-direction: column;
    }
    &:is(.long,.poetry) > div.title-page > div.count {
        grid-column: 1 / -1;
        display: block;
        margin-block-start: auto;
        margin-inline: auto;
    }

    & .contact p {
        text-align: start;
        text-indent: unset;
        margin-block: 0;
    }
    & .count p {
        text-align: end;
        text-indent: unset;
        margin-block: 0;
    }

    &:is(.long,.poetry) > div.title-page .count p {
        text-align: center;
        text-indent: unset;
        margin-block: 0;
    }

    /*
     * POEM TITLE, CONTACT, COUNT layout and orientation
     */

    /* all poem blocks start as 'display: contents' and span both grid cols */
    & section.poem > * {
        grid-column: 1 / -1;
        display: contents;
        flex-direction: column;
    }

    & section.poem > div.contact,
    & section.poem > div.count,
    & section.poem > div.title,
    & div.xxxxxxxx {
        grid-row: 1;
    }
    & section.poem > div.contact {
        grid-column: 1;
    }
    & section.poem > div.count {
        grid-column: 2;
    }
    & section.poem > div.title {
        grid-column: 1 / -1;
        display: flex;
        justify-content: center;
        flex-direction: column;
    }

    /*
     * VERTICAL LAYOUT - title pages, parts, chapters, scenes, and poems
     */

    /*
     * spacing for 1st page title page
     * (same for both short and long manuscripts)
     */
    & > div.title-page > div.title {
        padding-block-start: var(--m-offset-title-titlepage);
    }

    /*
     * short spacing
     *
     * title page +
     * [eight lines of space]
     * title page (flattened, because it's internal) >
     *     [eight lines of space]
     *     title
     *
     * section +
     * [eight lines of space]
     * title page (flattened, because it's internal) >
     *     [eight lines of space]
     *     title
     *
     * title page +
     * [four lines of space]
     * section:is(.part,.chapter)
     *
     * section >
     *     [four lines of space]
     *     section:is(.part,.chapter)
     *
     * section >
     *     [two lines of space]
     *     section:is(.scene)
     */
    &:not(.long,.poetry) {
        & > :is(div.title-page,section) + div.title-page {
            padding-block-start: var(--m-room-for-eight);
        & > div:is(.title) {
                padding-block-start: var(--m-room-for-eight);
            }
        }
        & > div.title-page + section,
        & section + section:is(.part,.chapter),
        & div.xxxxxxxx {
            padding-block-start: var(--m-room-for-four);
        }
        & section > section:first-of-type,
        & div.xxxxxxxx {
            padding-block-start: var(--m-room-for-four);
        }
        & section > section:first-of-type:is(.scene),
        & div.xxxxxxxx {
            padding-block-start: var(--m-room-for-two);
        }
    }

    /*
     * long spacing
     *
     * [page-break]
     * title page >
     *     [5/12 down the page]
     *     title
     *
     * title page +
     * [page-break]
     * section:is(.part,.chapter)
     *
     * FIXME FIXME FIXME
     *
     * section >
     *     [four lines of space]
     *     section:is(.part,.chapter)
     *
     * section >
     *     [two lines of space]
     *     section:is(.scene)
     */
    &:is(.long,.poetry) {
        & > :is(div.title-page,section) + div.title-page {
            padding-block-start: 0;
        & > div:is(.title) {
                padding-block-start: var(--m-offset-title-titlepage-interior);
            }
        }

        & > div.title-page + section,
        & section + section:is(.part,.chapter),
        & div.xxxxxxxx {
            padding-block-start: var(--m-offset-title);
        }
        & section > section:first-of-type,
        & div.xxxxxxxx {
            padding-block-start: var(--m-room-for-four);
        }
        & section > section:first-of-type:is(.scene),
        & div.xxxxxxxx {
            padding-block-start: var(--m-room-for-two);
        }
    }

    /*
     * poem spacing
     * Note, a poem in a manuscript should never be without contact & count but
     * if the work is just being shared … still, 1/4 offset is an aesthetic
     * choice.
     */
    /*& section.poem:has( > .contact, > .count ) > .title {*/
    & section.poem > .title {
        padding-block-start: var(--m-offset-title-poem);
    }


    /*
     * TITLE BLOCKS (.title) - configuration within
     */
    & .title {
        /* this should be, for a 8.5in page, about 77% */
        width: calc((var(--m-max-width-header) / var(--m-content-width)) * 100%);
        max-width: var(--m-max-width-header);

        margin-block: 0;
        margin-inline: auto;

        /* all header content starts as centered and with no spacing */
        & > :is(h1, h2, h3, h4, h5, h6),   /* all header H-tags */
        & > p {                            /* all header paragraphs */
            padding: 0; border: 0;
            margin-block: 0;
            margin-inline: auto;
            text-align: center;
            text-indent: unset;
        }
        & > p:first-of-type,
        & > pre:first-of-type {
            margin-block-start: var(--m-nudge);
        }

        /* the epigraphs */
        & > blockquote {
            width: max-content;
            max-width: min(var(--m-max-width-epigraph),100%);
            margin-block: var(--m-nudge) 0;
            margin-inline: auto;
            & p {
                text-indent: var(--m-indent-first-paragraph-epigraph);
            }
            & p ~ p {
                /* a paragraph after a paragraph is either indented (narrative)
                 * or not indented (nonnarrative) */
                text-indent: var(--m-indent);
                margin-block: var(--m-paragraph-spacing) 0;
            }
        }

        /* explicityly no top and bottom margins for first and last within
         * the title block */
        & > :first-child { margin-block-start: 0; }
        & > :last-child { margin-block-end: 0; }
    }


    /* TEXT-ONLY and SIMPLE
     *
     * #manuscript.text-only:
     *    removes all contact info, page & title headers, & counts
     * #manuscript.simple:
     *    removes the all page headers, contacts, & counts */
    &:is(.text-only) {
        & .title-page,
        & .contact,
        & .count,
        & .title {
            display: none !important;
        }
    }
    &:is(.simple) {
        & .contact,
        & .count {
            display: none !important;
        }
        & > div.title-page > div.title {
            padding-block-start: var(--m-room-for-eight);
        }
    }

} /* end #manuscript */



/* KEPT FOR POSTERITY ------------------------------------------ */

    /* contact and count: if block-style parent containers
     * (I think this is a little wrong and will not work the way we wish
     * anyway without html restructuring) */
    /*
    & .contact {
        display: block;
        float: inline-start;
        margin-block: 0;
    }
    & section.poem .count,
    & > div.title-page .count {
        display: block;
        float: inline-end;
        margin-block: unset;
        margin-inline: unset;
    }
    &:is(.long,.poetry) > div.title-page .count {
        margin-inline: auto;
    }
    */

    /* contact and count: if flex-style parent containers */
    /*
    & .contact {
        position: absolute;
        inset-inline: 0 auto;
        margin-block: 0;
    }

    & section.poem .count,
    & > div.title-page .count {
        position: absolute;
        inset-inline: auto 0;
        margin-block: unset;
        margin-inline: unset;
    }
    &:is(.long,.poetry) > div.title-page .count {
        position: absolute;
        inset-block-start: auto;
        margin-block: unset;
        margin-inline: auto;
    }
    */


/* spacing based on elements and not title */
    /*
    &:not(.long,.poetry) {
        / * an aesthetic gap * /
        & > :is(div.title-page,section):has(.contact,.count) + div.title-page {
            padding-block-start: var(--m-page-margin);
        }
        */
        /*
        & > div.title-page + section,
        & section:has( > .title ),
        & div.xxxxxxxx {
            padding-block-start: var(--m-room-for-two);
        }
        */
        /*
        & section > .title,
        & div.xxxxxxxx {
            padding-block-start: var(--m-room-for-two);
        }
        */
    /*
    &:is(.long,.poetry) {
        & > :is(div.title-page,section) + div.title-page:has(.contact,.count) {
            padding-block-start: unset;
        }
        & > div.title-page + section,
        & section:has( > .title ),
        & div.xxxxxxxx {
            padding-block-start: var(--m-offset-title);
        }
        & section:has( > .title ) > section:first-of-type:has( > .title),
        & section:has( > .title ) > section:first-of-type.scene,
        & div.xxxxxxxx {
            padding-block-start: var(--m-room-for-four);
        }
        & section.chapter:has( > .title ) > section:first-of-type.scene {
            padding-block-start: var(--m-room-for-two);
        }
        & section.poem {
            padding-block-start: unset;
        }
    }
    */


/* The title model of spacing … */

    /* TITLE METHOD --- this is faulty
    &:not(.long,.poetry) {
        & > :is(div.title-page,section) + div.title-page > div:is(.title, .contact, .count) {
            padding-block-start: var(--m-room-for-eight);
        }
        & > div.title-page + section > .title,
        & section:not(section.poem):has( > .title ) > .title,
        & div.xxxxxxxx {
            padding-block-start: var(--m-room-for-four);
        }
        & section:has( > .title ) > section:first-of-type:has( > .title) > .title,
        & div.xxxxxxxx {
            padding-block-start: var(--m-room-for-four);
        }
        & > div.title-page + section:first-of-type:is(.scene),
        & section:has( > .title ) > section:first-of-type:is(.scene),
        & section:is(.chapter):has( > .title ) > section:first-of-type:is(.scene) {
            padding-block-start: var(--m-room-for-two);
        }
        & section:has( > .title ) > section:first-of-type:is(.scene):has( > .title ) {
            padding-block-start: 0;
            & > .title {
                padding-block-start: var(--m-room-for-two);
            }
        }
    }
    */
    /* TITLE METHOD --- this is faulty
    &:is(.long,.poetry) {
        & > :is(div.title-page,section) + div.title-page > div.title {
            padding-block-start: var(--m-offset-title-titlepage-interior);
        }

        & > div.title-page + section > .title,
        & section:not(section.poem):has( > .title ) > .title,
        & div.xxxxxxxx {
            padding-block-start: var(--m-offset-title);
        }
        & section:has( > .title ) > section:first-of-type:has( > .title) > .title,
        & div.xxxxxxxx {
            padding-block-start: var(--m-room-for-four);
        }
        & > div.title-page + section:first-of-type:is(.scene),
        & section:has( > .title ) > section:first-of-type:is(.scene),
        & section:is(.chapter):has( > .title ) > section:first-of-type:is(.scene) {
            padding-block-start: var(--m-room-for-two);
        }
        & section:has( > .title ) > section:first-of-type:is(.scene):has( > .title ) {
            padding-block-start: 0;
            & > .title {
                padding-block-start: var(--m-room-for-two);
            }
        }
    }
    */

