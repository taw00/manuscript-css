/* Page breaks and simulated page breaks
 *
 * Note, if you start mixing up odd things sometimes page breaking can get odd
 * as well. So, be mindful if you see a blank page or stacks of simulated page
 * break lines or parts and chapters with no scene afterward, that maybe you
 * shouldn't have done whatever you have done.
 *
 * Copyright (c) Todd Warner
 * This work is licensed under Attribution 4.0 International. To view a copy
 * of this license, visit http://creativecommons.org/licenses/by/4.0/
 */


/*
 * PAGE BREAKS, SIMULATED - only ever set if #manuscript.long (or .poetry)
 */
@media screen {
    #manuscript {
        /*
         * page-breaks dependent on 'short' vs. 'long'
         * :is(.long,.poetry) > .m-title-page + anything = page break
         * .m-book = page break
         * .m-book + anything = page break
         * .m-part = page break
         * .m-part > .m-chapter = NO page break (therefore not declared)
         * .m-chapter + .m-chapter = page break
         * .m-scene + .m-chapter = page break (why would this happen?)
         */

        /* SHORT stuff */
        & > :is(div.m-title-page,section):has(.m-contact,.m-count) + div.m-title-page {
            /*padding-block-start: calc(var(--m-room-for-two) * 2);*/
            padding-block-start: var(--m-page-margin);
        }
        & > div.m-title-page + section,
        & > section.m-book:has( > .m-title),
        & > section.m-book:has( > .m-title) + section,
        & section.m-part:has( > .m-title),
        & section.m-chapter:has( ~ section ) + .m-chapter:has( > .m-title ),
        & section.m-scene + .m-chapter:has( > .m-title ) {
            padding-block-start: var(--m-room-for-two);
        }

        /* LONG stuff */
        /*&:is(.long,.poetry) > :is(div.m-title-page,section) + div.m-title-page,*/
        &:is(.long,.poetry) > div.m-title-page + section,
        &:is(.long,.poetry) > section.m-book:has( > .m-title),
        &:is(.long,.poetry) > section.m-book:has( > .m-title) + section,
        &:is(.long,.poetry) section.m-part:has( > .m-title),
        &:is(.long,.poetry) section.m-chapter:has( ~ section ) + .m-chapter:has( > .m-title ),
        &:is(.long,.poetry) section.m-scene + .m-chapter:has( > .m-title ) {
            padding-block-start: var(--m-offset-title);
            border-block-start: var(--m-page-break-simulated);
        }
        /* interior m-title-page page breaks */
        &:is(.long,.poetry) > :is(div.m-title-page,section) + div.m-title-page {
            border-block-start: var(--m-page-break-simulated);
        }
        /* interior m-title-page spacing changes if it has a count or contact */
        &:is(.long,.poetry) > :is(div.m-title-page,section) + div.m-title-page:has(.m-contact,.m-count) {
            padding-block-start: unset;
        }

        /*
         * Poems
         * .m-poem = page break (unless it is the very first thing)
         * .m-poem + anything = page break
         */
        &:is(.long,.poetry) :is(div.m-title-page,section) + section.m-poem,
        &:is(.long,.poetry) section.m-poem + section {
            border-block-start: var(--m-page-break-simulated-long);
        }
    } /* end #manuscript */
} /* end @media screen */


/*
 * PAGE BREAKS - only ever set if #manuscript.long (or .poetry)
 */
@media print {
    #manuscript {
        /*
         * page-breaks dependent on 'short' vs. 'long'
         * :is(.long,.poetry) > .m-title-page + anything = page break
         * .m-book = page break
         * .m-book + anything = page break
         * .m-part = page break
         * .m-part > .m-chapter = NO page break (therefore not declared)
         * .m-chapter + .m-chapter = page break
         * .m-scene + .m-chapter = page break (why would this happen?)
         */

        /* SHORT stuff */
        & > :is(div.m-title-page,section):has(.m-contact,.m-count) + div.m-title-page {
            /*padding-block-start: calc(var(--m-room-for-two) * 2);*/
            padding-block-start: var(--m-page-margin);
        }
        & > div.m-title-page + section,
        & section.m-book:has( > .m-title),
        & section.m-book:has( > .m-title) + section,
        & section.m-part:has( > .m-title),
        & section.m-chapter:has( ~ section ) + .m-chapter:has( > .m-title ),
        & section.m-scene + .m-chapter:has( > .m-title ) {
            padding-block-start: var(--m-room-for-two);
        }

        /* LONG stuff */
        /*&:is(.long,.poetry) > :is(div.m-title-page,section) + div.m-title-page,*/
        &:is(.long,.poetry) > div.m-title-page + section,
        &:is(.long,.poetry) section.m-book:has( > .m-title),
        &:is(.long,.poetry) section.m-book:has( > .m-title) + section,
        &:is(.long,.poetry) section.m-part:has( > .m-title),
        &:is(.long,.poetry) section.m-chapter:has( ~ section ) + .m-chapter:has( > .m-title ),
        &:is(.long,.poetry) section.m-scene + .m-chapter:has( > .m-title ) {
            padding-block-start: var(--m-offset-title);
            break-before: var(--m-page-break);
        }
        /* interior m-title-page page breaks */
        &:is(.long,.poetry) > :is(div.m-title-page,section) + div.m-title-page {
            break-before: var(--m-page-break);
        }
        /* interior m-title-page spacing changes if it has a count or contact */
        &:is(.long,.poetry) > :is(div.m-title-page,section) + div.m-title-page:has(.m-contact,.m-count) {
            padding-block-start: unset;
        }

        /*
         * Poems
         * .m-poem = page break (unless it is the very first thing)
         * .m-poem + anything = page break
         */
        &:is(.long,.poetry) :is(div.m-title-page,section) + section.m-poem,
        &:is(.long,.poetry) section.m-poem + section {
            break-before: page;
        }

        /* AVOIDANCE ----- */

        & a,
        & tr {
            break-inside: avoid-page !important;
        }

        & :is(h1, h2, h3, h4, h5, h6),
        & :is(img, figure) {
            break-inside: avoid-page !important;
            break-after: avoid-page !important;
        }


        /* avoid page break inside a note */
        & .m-note,
        /* avoid page break inside a poem stanza */
        & .x-poem pre,
        & section.m-poem pre,
        /* avoid page break inside a header blocks */
        & .m-contact,
        & .m-count {
            break-inside: avoid-page !important;
        }

        /* avoid page break before a dinkus or -30- marker */
        & section.m-scene::after,
        &::after,
        & h6 {
            break-before: avoid-page !important;
            break-inside: avoid-page !important;
        }
    } /* end #manuscript */

    #vpage, #manuscript, #manuscript > div.m-title-page {
        break-before: avoid-page !important;
    }

} /* end @media print */

